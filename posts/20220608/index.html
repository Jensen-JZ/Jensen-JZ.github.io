<!DOCTYPE html>
<html lang=""><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <title>NVIDIA DALIè¸©å‘æ•™ç¨‹</title>
    <meta name="description" content="A simple homepage of Jensen Zhang.">
    <meta name="author" content='Jensen Zhang'>

    <link href="https://cdn.jsdelivr.net/gh/Jen-Jon/CDN_Bank/srcs/homepage_css2.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/gh/Jen-Jon/CDN_Bank/srcs/buttonsstyle.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w==" crossorigin="anonymous">

    <script defer src="https://cdn.jsdelivr.net/gh/Jen-Jon/CDN_Bank/srcs/backbutton.js"></script>
    <script async src="https://cdn.jsdelivr.net/gh/Jen-Jon/CDN_Bank/srcs/busuanzi.pure.mini.js"></script>

    
    <script>
        WIDGET = {
        "CONFIG": {
            "modules": "0124",
            "background": "5",
            "tmpColor": "fff",
            "tmpSize": "16",
            "tmpPadding": "10px",
            "cityColor": "000",
            "citySize": "16",
            "aqiColor": "fff",
            "aqiSize": "16",
            "weatherIconSize": "24",
            "alertIconSize": "18",
            "padding": "0px",
            
            "language": "en",
            "key": "06a49925209149af84e325a6c7e5c521"
        }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/gh/Jen-Jon/CDN_Bank/srcs/he-simple-common-v2.0.js"></script>
    

    
    <script>
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?a4cacad7bf6ee4f58534d26d5b23ad14";
          var s = document.getElementsByTagName("script")[0]; 
          s.parentNode.insertBefore(hm, s);
        })();
    </script>
    

    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/3.2.0/fuse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/Jen-Jon/CDN_Bank/srcs/search-v1.3.js"></script>

    
    <script id="search-result-template" type="text/x-js-template">
        <article id="summary-${key}">
            <header>
                <h3><i class="fas fa-file-alt"></i> <a href="${link}">${title}</a></h3>
                <h4>${date} | ${type} blog | ${tags}</h4>
            </header>
            <div>
                <div>${snippet}...</div>
                
                <div class="ReadButton">
                    <a class="read-more-link ReadButton_a" href="https://jen-jon.github.io/posts/20220608/">
                        <strong style="color: #fff;">Read More</strong>
                    </a>
                </div>
                
            </div>
            <hr>
        </article>
    </script>

    
    <link rel="stylesheet" href="/sass/researcher.min.css">

    
        <link rel="icon" type="image/ico" href="https://jen-jon.github.io/images/favicon.ico">
    

    
        
    
</head>

    <body><div id="ukraine" style="background-color: #1f71e0; ">
    <a class="cba fas fa-window-close" onclick="test()" style="display:block; float:right; width:30px; height:29px;" href="#"></a>
    <div style="height: 50px; display: flex; text-align: center; justify-content: center; align-items: center;">
        <div style="margin: 0 10px;">
            <div style="font-size: 45px;">ğŸ‡ºğŸ‡¦</div>
        </div>
        <div style="margin: 0 10px;">
            <a style="color: white;" href="/we-stand-with-ukraine">
                <div style="color: white; font-weight: bold; font-size: large;">We stand with Ukraine!</div>
                <div style="color: white; font-weight: bold; font-size: large;">æˆ‘ä»¬æ”¯æŒä¹Œå…‹å…°ï¼</div>
            </a>
        </div>
    </div>
</div>
<script>
    function test() {
        document.getElementById("ukraine").parentElement.removeChild(document.getElementById("ukraine"));
    }
</script>

<div class="container mt-5" style="text-align: right;">
    
    <div style="display: inline-flex; background-color: #1f71e0;">
        <div id="he-plugin-simple"></div>
    </div>
    
    <nav class="navbar navbar-expand-sm flex-column flex-sm-row text-nowrap p-0">
        <a class="navbar-brand mx-0 mr-sm-auto" href="https://jen-jon.github.io/" title="Jensen&#39;s Homepage">
          
          <i class="fas fa-home"></i>
          Jensen&#39;s Homepage
        </a>
        <div class="navbar-nav flex-row flex-wrap justify-content-center">
            
                
                
                    <a class="nav-item nav-link" href="/about" title="About">
                        About
                    </a>
                    
                        <span class="nav-item navbar-text mx-1">/</span>
                    
                
                    <a class="nav-item nav-link" href="/posts" title="Posts">
                        Posts
                    </a>
                    
                        <span class="nav-item navbar-text mx-1">/</span>
                    
                
                    <a class="nav-item nav-link" href="/mediatest" title="Media">
                        Media
                    </a>
                    
                        <span class="nav-item navbar-text mx-1">/</span>
                    
                
                    <a class="nav-item nav-link" href="https://cdn.jsdelivr.net/gh/Jen-Jon/CDN_Bank/srcs/Resume_of_Jensen.pdf" title="Resume/CV">
                        Resume/CV
                    </a>
                    
                
            
        </div>
    </nav>
</div>
<hr><div id="content">
<div class="container">
    
    <h1 style="color: #1f71e0;">NVIDIA DALIè¸©å‘æ•™ç¨‹</h1>
    
    <h5>Posted by <a href="https://jen-jon.github.io/">Jensen Zhang</a> on <em>June 8, 2022</em> | <spa id="busuanzi_container_page_pv"><i class="fas fa-eye"></i> <em><span id="busuanzi_value_page_pv"></span></em> readings</span> </h5>
    
    <h5>This article is about <em style="color: #1f71e0;">3641</em> words and may take <em style="color: #1f71e0;">8</em> minutes to read.</h5>
    <hr>
    
    
    <p><img src="https://cdn.jsdelivr.net/gh/Jen-Jon/CDN_Bank/img_src/20220608/title.png" alt="Logo"/></p>
    <hr>
    
    
    <blockquote>
        <p><strong>Type: technology blog</strong></p>
        <p><strong>Tags: NVIDIA DALI; Deep Learning</strong></p>
    </blockquote>
    <hr>
    
    
    <h1 style="color: #1f71e0;">Content</h1>
    <br>
    
    <h2 id="åˆè§">åˆè§</h2>
<p>äº‹æƒ…çš„èµ·å› è¿˜è¦è¿½æº¯åˆ°å¾ˆä¹…ä¹‹å‰çœ‹äº†ä¸€ç¯‡è®ºæ–‡ï¼Œè®ºæ–‡çš„æ ¸å¿ƒå°±æ˜¯è®¨è®ºé¢„è®­ç»ƒç­–ç•¥åœ¨ä½å±‚è§†è§‰ä»»åŠ¡ä¸­çš„ä½œç”¨ã€‚æ—¢ç„¶æ˜¯é¢„è®­ç»ƒç­–ç•¥ï¼Œé‚£å°±ä¸å¯é¿å…çš„è¦ç”¨è§„æ¨¡å¤§ä¸€ç‚¹çš„æ•°æ®é›†ï¼Œä¹‹æ‰€ä»¥é¢„è®­ç»ƒè¿™äº›å¹´åœ¨ä½å±‚è§†è§‰ä»»åŠ¡ä¸­é²œè¢«åº”ç”¨çš„ï¼Œå…¶ä¸»è¦çš„åŸå› å°±æ˜¯ç¼ºä¹å¤§è§„æ¨¡æ•°æ®é›†ã€‚è¿™ç¯‡è®ºæ–‡ä¸»è¦é’ˆå¯¹ä½å±‚è§†è§‰ä»»åŠ¡ä¸­çš„SRï¼ˆè¶…åˆ†è¾¨ç‡ï¼‰ã€DeRainï¼ˆå»é›¨ï¼‰å’ŒDeNoiseï¼ˆå»å™ªï¼‰ä¸‰ä¸ªä»»åŠ¡ï¼Œä½œè€…åˆ©ç”¨ImageNetä¸­çš„å›¾åƒä½œä¸ºåŸºå‡†å›¾åƒï¼Œå¹¶åœ¨æ­¤åŸºç¡€ä¸Šåˆ©ç”¨åŒä¸‰æ¬¡æ’å€¼å¾—åˆ°ä½åˆ†è¾¨ç‡å›¾åƒç”¨äºSRä»»åŠ¡ï¼Œå°†é›¨çº¹å’Œé«˜æ–¯å™ªå£°ç›´æ¥åŠ å…¥åˆ°å¹²å‡€çš„åŸºå‡†å›¾åƒä¸­ç”¨äºDeRainå’ŒDeNoiseä»»åŠ¡ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/Jen-Jon/CDN_Bank/img_src/20220608/001.png" alt="001"></p>
<p>ä½†æ˜¯è®ºæ–‡ä¸­å´å¿½ç•¥äº†ä½å±‚è§†è§‰ä¸­ä¸€ä¸ªéå¸¸é‡è¦çš„é—®é¢˜ï¼Œå³ä½å…‰å¢å¼ºä»»åŠ¡ï¼ˆLow-light Image Enhancementï¼‰ã€‚æˆ‘è§‰å¾—ä¸»è¦é—®é¢˜å°±æ˜¯ä½å…‰å¢å¼ºä»»åŠ¡ä¸­æ‰€ç”¨åˆ°çš„é…å¯¹å›¾åƒæ•°æ®é›†æ˜¯å¾ˆéš¾è·å¾—çš„ï¼Œç‰¹åˆ«æ˜¯ç”¨ImageNetæ¥ç”Ÿæˆï¼Œæ›´æ˜¯éš¾ä¸ŠåŠ éš¾ã€‚å…¶ä¸€ï¼Œä½å…‰ç¯å¢ƒæ˜¯ä¸ªå¾ˆå¤æ‚çš„ç¯å¢ƒï¼Œä¸æ˜¯ç®€å•è°ƒä½å›¾åƒçš„äº®åº¦å°±èƒ½å®ç°çš„ï¼Œåœ¨ä½å…‰ç¯å¢ƒä¸‹æ‹æ‘„çš„å›¾åƒå¾€å¾€æ˜¯æœ‰çš„åœ°æ–¹æš—æœ‰çš„åœ°æ–¹äº®ï¼›å…¶äºŒï¼Œä½å…‰ç¯å¢ƒä¸‹æ‘„å¾—çš„å›¾åƒå¾€å¾€ä¼´éšç€å„ç§å¤æ‚çš„å™ªå£°ï¼Œç®€å•çš„å¾€å›¾åƒä¸Šå åŠ å™ªå£°å¯èƒ½å¹¶ä¸çœŸå®ã€‚å‰ä¸ä¹…æˆ‘å…‹æœäº†è¿™ä¸¤ä¸ªé—®é¢˜ï¼ŒæˆåŠŸä»ImageNet/VOC/COCO/IAPR/StreetScenesè¿™äº”ä¸ªæ•°æ®é›†ä¸­æŒ‘é€‰ä¸€äº›åˆé€‚çš„å›¾åƒæ„é€ äº†ä¸€ä¸ªå¤§è§„æ¨¡é…å¯¹çš„æš—å…‰å›¾åƒæ•°æ®é›†ï¼Œå…¶ä¸­å…±åŒ…å«äº†153,856å¯¹æš—å…‰/æ­£å¸¸å…‰å›¾åƒï¼ˆå…·ä½“æ•°æ®é›†æ˜¯å¦‚ä½•æ„é€ çš„ä»Šå¤©å°±ä¸èµ˜è¿°äº†ï¼Œç­‰è®ºæ–‡å‘è¡¨åæˆ‘ä¼šè¯¦ç»†è·Ÿå¤§å®¶è§£é‡Šï¼‰ã€‚æˆ‘ä»¬çŸ¥é“ï¼ŒPyTorchä¸­æä¾›äº†<code>torch.utils.data.Dataset(*args, **kwds)</code>å’Œ<code>torch.utils.data.DataLoader(dataset, ...)</code>è¿™ä¸¤ä¸ªç±»æ¥å®ç°æ•°æ®é›†çš„æ„å»ºå’Œæ•°æ®çš„åŠ è½½ï¼Œä½†æ˜¯è¿™ä¸¤ä¸ªç±»éƒ½æ˜¯ä½œç”¨åœ¨CPUä¸Šçš„ã€‚ç„¶è€Œæˆ‘ä»¬çš„é¢„è®­ç»ƒæ•°æ®é›†çš„è§„æ¨¡è¾¾åˆ°äº†153,856*2å¼ ï¼Œç”¨CPUæ¥åŠ è½½é€Ÿåº¦å®åœ¨å¤ªæ…¢äº†ï¼Œåœ¨åç»­è®­ç»ƒçš„è¿‡ç¨‹ä¸­å¯èƒ½ä¼šå¯¼è‡´æ¨¡å‹ç­‰å¾…æ•°æ®ä¼ å…¥çš„æƒ…å†µï¼Œå³æ¨¡å‹å·²ç»è®­ç»ƒå®Œä¸€ä¸ªbatchçš„æ•°æ®äº†ï¼Œä½†æ˜¯ä¸‹ä¸€ä¸ªbatchçš„æ•°æ®è¿˜åœ¨åŠ è½½ï¼Œæ²¡èƒ½åŠæ—¶ä¼ åˆ°æ¨¡å‹ä¸­ï¼Œè¿™æ ·ä¼šå¯¼è‡´GPUçš„åˆ©ç”¨ç‡æ˜¾è‘—ä¸‹é™ã€‚ä¹Ÿå°±æ˜¯è¯´ä¸ä»…ä¼šé™ä½æ¨¡å‹è®­ç»ƒçš„é€Ÿåº¦ï¼ŒåŒæ—¶ä¹Ÿæ²¡èƒ½å®Œå…¨å‹æ¦¨å‡ºæ˜¾å¡ç­‰ç¡¬ä»¶çš„æ€§èƒ½ï¼Œæ˜¯ä¸€ä»¶æ€§ä»·æ¯”æä½çš„äº‹æƒ…ã€‚ä¸‹é¢ä¸¾ä¸ªğŸŒ°ï¼ˆä¾‹å­ï¼‰ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> os
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> torch
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> torch.nn <span style="color:#66d9ef">as</span> nn
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> PIL <span style="color:#f92672">import</span> Image
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> torchvision <span style="color:#f92672">import</span> transforms
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> torch.utils.data <span style="color:#f92672">import</span> Dataset, DataLoader, random_split
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>torch<span style="color:#f92672">.</span>__version__
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>DATA_DIR <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/home/jensen/workspace/DATASETS/SYNTHETIC_DATA&#34;</span>
</span></span><span style="display:flex;"><span>BATCH_SIZE <span style="color:#f92672">=</span> <span style="color:#ae81ff">128</span>
</span></span><span style="display:flex;"><span>IMAGE_SIZE <span style="color:#f92672">=</span> <span style="color:#ae81ff">192</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>syn_trans <span style="color:#f92672">=</span> transforms<span style="color:#f92672">.</span>Compose([
</span></span><span style="display:flex;"><span>    transforms<span style="color:#f92672">.</span>Resize((IMAGE_SIZE, IMAGE_SIZE)), 
</span></span><span style="display:flex;"><span>    transforms<span style="color:#f92672">.</span>ToTensor(),
</span></span><span style="display:flex;"><span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Syn_Dataset</span>(nn<span style="color:#f92672">.</span>Module):
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __init__(self, low_path, high_path, transforms<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>low_path <span style="color:#f92672">=</span> low_path
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>high_path <span style="color:#f92672">=</span> high_path
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>transforms <span style="color:#f92672">=</span> transforms
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __getitem__(self, idx):
</span></span><span style="display:flex;"><span>        low_files <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>listdir(self<span style="color:#f92672">.</span>low_path)
</span></span><span style="display:flex;"><span>        high_files <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>listdir(self<span style="color:#f92672">.</span>high_path)
</span></span><span style="display:flex;"><span>        low_image <span style="color:#f92672">=</span> Image<span style="color:#f92672">.</span>open(os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(self<span style="color:#f92672">.</span>low_path, low_files[idx]))
</span></span><span style="display:flex;"><span>        high_image <span style="color:#f92672">=</span> Image<span style="color:#f92672">.</span>open(os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(self<span style="color:#f92672">.</span>low_path, high_files[idx]))
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>transforms:
</span></span><span style="display:flex;"><span>            low_image <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>transforms(low_image)
</span></span><span style="display:flex;"><span>            high_image <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>transforms(high_image)
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> low_image, high_image
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __len__(self):
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> len(os<span style="color:#f92672">.</span>listdir(self<span style="color:#f92672">.</span>low_path))
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>dataset <span style="color:#f92672">=</span> Syn_Dataset(low_path<span style="color:#f92672">=</span>os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(DATA_DIR, <span style="color:#e6db74">&#34;low&#34;</span>), high_path<span style="color:#f92672">=</span>os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(DATA_DIR, <span style="color:#e6db74">&#34;low&#34;</span>), transforms<span style="color:#f92672">=</span>syn_trans)
</span></span><span style="display:flex;"><span>train_data, val_data <span style="color:#f92672">=</span> random_split(dataset, (<span style="color:#ae81ff">152000</span>, <span style="color:#ae81ff">1856</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>val_loader <span style="color:#f92672">=</span> DataLoader(val_data, batch_size<span style="color:#f92672">=</span>BATCH_SIZE, shuffle<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, num_workers<span style="color:#f92672">=</span><span style="color:#ae81ff">4</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">%%</span>time
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> idx, data <span style="color:#f92672">in</span> enumerate(val_loader):
</span></span><span style="display:flex;"><span>    X, Y <span style="color:#f92672">=</span> data
</span></span><span style="display:flex;"><span>    print(X<span style="color:#f92672">.</span>shape)
</span></span></code></pre></div><p>ä¸Šé¢è¿™ä¸ªä¾‹å­ä½¿ç”¨PyTorchå†…ç½®çš„DataLoaderç±»ä»¥<code>batch_size = 128</code>éå†äº†ä¸€é<code>val_dataset</code>ï¼Œå¹¶æ‰“å°æ¯ä¸ªbatchçš„å°ºå¯¸ã€‚ä½¿ç”¨<code>jupyter</code>çš„<code>%%time</code>é­”æ³•è¯­è¨€æ¥è®¡ç®—éå†ä¸€éæ‰€èŠ±è´¹çš„æ—¶é—´ï¼Œä»ä¸‹å›¾å¯ä»¥ç›´è§‚çœ‹åˆ°ï¼Œä¸€å…±èŠ±è´¹è¿‘ä¸¤åˆ†é’Ÿå®Œæˆä¸€æ¬¡éå†ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/Jen-Jon/CDN_Bank/img_src/20220608/002.png" alt="002"></p>
<p>æ¥ä¸‹æ¥å†ä¸¾ä¸ªğŸŒ°ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> torchvision <span style="color:#f92672">import</span> models
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>model <span style="color:#f92672">=</span> models<span style="color:#f92672">.</span>alexnet(pretrained<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)<span style="color:#f92672">.</span>cuda()
</span></span><span style="display:flex;"><span>criterion <span style="color:#f92672">=</span> nn<span style="color:#f92672">.</span>CrossEntropyLoss()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> idx, data <span style="color:#f92672">in</span> enumerate(val_loader):
</span></span><span style="display:flex;"><span>  	X, Y <span style="color:#f92672">=</span> data
</span></span><span style="display:flex;"><span>    output <span style="color:#f92672">=</span> model(X<span style="color:#f92672">.</span>cuda())
</span></span><span style="display:flex;"><span>    loss <span style="color:#f92672">=</span> criterion(out<span style="color:#f92672">.</span>cpu(), torch<span style="color:#f92672">.</span>empty(out<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">0</span>], dtype<span style="color:#f92672">=</span>torch<span style="color:#f92672">.</span>long)<span style="color:#f92672">.</span>random_(<span style="color:#ae81ff">1000</span>))
</span></span><span style="display:flex;"><span>    loss<span style="color:#f92672">.</span>backward()
</span></span></code></pre></div><p>ä¸Šé¢è¿™ä¸ªä¾‹å­æ˜¯æ¨¡æ‹Ÿå°†æ•°æ®è¾“å…¥AlexNetä¸­å¤„ç†ï¼Œä»ä¸‹å›¾ä¸­å¯ä»¥çœ‹åˆ°GPUçš„åˆ©ç”¨ç‡å¾ˆä½ï¼ˆå¤§å¤šæ•°æ—¶é—´éƒ½æ˜¯0%ï¼‰ã€‚ä¸»è¦åŸå› æ˜¯æ¨¡å‹å¤„ç†æ•°æ®çš„æ—¶é—´æ¯”æ•°æ®åŠ è½½çš„æ—¶é—´æ›´å¿«ï¼Œä¹Ÿå°±æ„å‘³ç€æ¨¡å‹é€šå¸¸è¦ç­‰å¾…DataLoaderå°†æ–°çš„batchçš„æ•°æ®ä¼ è¿‡æ¥ï¼Œå¯¼è‡´GPUçš„åˆ©ç”¨ç‡å¤§å¤šæ•°æ—¶é—´éƒ½å¤„äºè¾ƒä½çš„çŠ¶æ€ç”šè‡³æ˜¯ç©ºé—²ï¼Œä¸¥é‡æ‹–æ…¢æ¨¡å‹è®­ç»ƒçš„æ•ˆç‡ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/Jen-Jon/CDN_Bank/img_src/20220608/003.png" alt="003"></p>
<p>è¦æ˜¯æ•°æ®è§„æ¨¡å°çš„è¯ï¼Œè¿™ç‚¹æ—¶é—´ä¹Ÿä¸ç®—ä»€ä¹ˆï¼Œä½†æ˜¯æˆ‘çš„æ•°æ®è§„æ¨¡æ˜¯æ•°åä¸‡çº§åˆ«çš„ï¼Œæ¯ä¸€åˆ†ä¸€ç§’éƒ½å¯ä»¥è¯´æ˜¯ååˆ†çè´µçš„ï¼Œäºæ˜¯æˆ‘æ‰¾åˆ°äº†ä¸€ä¸ªéå¸¸niceçš„åŠ é€Ÿå·¥å…·ï¼š<a href="https://github.com/NVIDIA/DALI">NVIDIA DALI</a>åº“ã€‚</p>
<h2 id="å•å¡ç¯å¢ƒä¸‹çš„nvidia-daliä½¿ç”¨">å•å¡ç¯å¢ƒä¸‹çš„NVIDIA DALIä½¿ç”¨</h2>
<p>ï¼ˆNVIDIA DALIçš„å…·ä½“ä½¿ç”¨æ–¹å¼è¯·å‚é˜…<a href="https://docs.nvidia.com/deeplearning/dali/user-guide/docs/">å®˜æ–¹æ–‡æ¡£</a>ï¼‰</p>
<h3 id="å®‰è£…">å®‰è£…</h3>
<p>é¦–å…ˆéœ€è¦ç¡®å®šè‡ªå·±çš„cudaç‰ˆæœ¬ï¼Œå¯ä»¥åœ¨å‘½ä»¤è¡Œä¸­è¾“å…¥<code>nvcc -V</code>æ¥æŸ¥è¯¢ï¼Œå¦‚ä¸‹å›¾ï¼Œcudaç‰ˆæœ¬ä¸º10.2ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/Jen-Jon/CDN_Bank/img_src/20220608/004.png" alt="004"></p>
<p>ç´§æ¥ç€åœ¨å‘½ä»¤è¡Œä¸­è¾“å…¥<code>pip install nvidia-pyindex &amp;&amp; pip install nvidia-dali-cuda102</code>ï¼Œè¯·æ³¨æ„ï¼Œè¿™é‡Œçš„<code>cuda102</code>æ­£æ˜¯å¯¹åº”äº†ä¸Šé¢æŸ¥è¯¢çš„cudaç‰ˆæœ¬10.2ã€‚</p>
<h3 id="å•å¡ç¯å¢ƒä¸‹ä½¿ç”¨">å•å¡ç¯å¢ƒä¸‹ä½¿ç”¨</h3>
<p>æ‰€è°“å•å¡ç¯å¢ƒä¸‹ä½¿ç”¨å³è®­ç»ƒçš„è¿‡ç¨‹ä¸­åªä½¿ç”¨ä¸€å¼ å¡ï¼Œè¿™æ˜¯æœ€ç®€å•çš„å½¢å¼ã€‚å¯ä»¥è‡ªå·±å®šä¹‰æ•°æ®çš„è¿­ä»£æ–¹å¼ï¼Œæ•°æ®çš„Pipelineä»¥åŠåŠ è½½æ–¹å¼ã€‚è¯¦ç»†ç»†èŠ‚è¯·çœ‹ä»£ç ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> os
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> torch
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> numpy <span style="color:#66d9ef">as</span> np
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> random <span style="color:#f92672">import</span> shuffle
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> nvidia.dali.fn <span style="color:#66d9ef">as</span> fn
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> nvidia.dali.types <span style="color:#66d9ef">as</span> types
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> torch.utils.data <span style="color:#f92672">import</span> random_split
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> nvidia.dali.pipeline <span style="color:#f92672">import</span> Pipeline
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> nvidia.dali.plugin.pytorch <span style="color:#f92672">import</span> DALIGenericIterator, LastBatchPolicy
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>torch<span style="color:#f92672">.</span>__version__
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ExternalInputIterator</span>(object):
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __init__(self, batch_size, files, data_dir):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>low_dir <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(data_dir, <span style="color:#e6db74">&#39;low&#39;</span>)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>high_dir <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(data_dir, <span style="color:#e6db74">&#39;high&#39;</span>)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>batch_size <span style="color:#f92672">=</span> batch_size
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>files <span style="color:#f92672">=</span> list(files)
</span></span><span style="display:flex;"><span>        shuffle(self<span style="color:#f92672">.</span>files)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __len__(self):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> len(self<span style="color:#f92672">.</span>files)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __iter__(self):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>n <span style="color:#f92672">=</span> len(self<span style="color:#f92672">.</span>files)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> self
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __next__(self):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>i <span style="color:#f92672">&gt;=</span> self<span style="color:#f92672">.</span>n:
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>__iter__()
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">StopIteration</span>
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>        low <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>        high <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        leave_num <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>n <span style="color:#f92672">-</span> self<span style="color:#f92672">.</span>i
</span></span><span style="display:flex;"><span>        current_batch_size <span style="color:#f92672">=</span> min(self<span style="color:#f92672">.</span>batch_size, leave_num)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> _ <span style="color:#f92672">in</span> range(current_batch_size):
</span></span><span style="display:flex;"><span>            filename <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>files[self<span style="color:#f92672">.</span>i]
</span></span><span style="display:flex;"><span>            l <span style="color:#f92672">=</span> open(os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(self<span style="color:#f92672">.</span>low_dir, filename), <span style="color:#e6db74">&#39;rb&#39;</span>)
</span></span><span style="display:flex;"><span>            h <span style="color:#f92672">=</span> open(os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(self<span style="color:#f92672">.</span>high_dir, filename), <span style="color:#e6db74">&#39;rb&#39;</span>)
</span></span><span style="display:flex;"><span>            low<span style="color:#f92672">.</span>append(np<span style="color:#f92672">.</span>frombuffer(l<span style="color:#f92672">.</span>read(), dtype<span style="color:#f92672">=</span>np<span style="color:#f92672">.</span>uint8))
</span></span><span style="display:flex;"><span>            high<span style="color:#f92672">.</span>append(np<span style="color:#f92672">.</span>frombuffer(h<span style="color:#f92672">.</span>read(), dtype<span style="color:#f92672">=</span>np<span style="color:#f92672">.</span>uint8))
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>i <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> (low, high)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    next <span style="color:#f92672">=</span> __next__
</span></span><span style="display:flex;"><span>    len <span style="color:#f92672">=</span> __len__
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ExternalSourcePipeline</span>(Pipeline):
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __init__(self, data_iterator, batch_size, num_threads, device_id, img_size):
</span></span><span style="display:flex;"><span>        super(ExternalSourcePipeline, self)<span style="color:#f92672">.</span>__init__(batch_size, num_threads, device_id, exec_async<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>, exec_pipelined<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>img_size <span style="color:#f92672">=</span> img_size
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>batch <span style="color:#f92672">=</span> batch_size
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>data_iterator <span style="color:#f92672">=</span> data_iterator
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>lows, self<span style="color:#f92672">.</span>highs <span style="color:#f92672">=</span> fn<span style="color:#f92672">.</span>external_source(source<span style="color:#f92672">=</span>self<span style="color:#f92672">.</span>data_iterator, num_outputs<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>, dtype<span style="color:#f92672">=</span>types<span style="color:#f92672">.</span>UINT8)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __len__(self):
</span></span><span style="display:flex;"><span>        length <span style="color:#f92672">=</span> len(self<span style="color:#f92672">.</span>data_iterator) 
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> (length <span style="color:#f92672">//</span> self<span style="color:#f92672">.</span>batch <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>) <span style="color:#66d9ef">if</span> (length <span style="color:#f92672">%</span> self<span style="color:#f92672">.</span>batch <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) <span style="color:#66d9ef">else</span> (length <span style="color:#f92672">//</span> self<span style="color:#f92672">.</span>batch) 
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">define_graph</span>(self):
</span></span><span style="display:flex;"><span>        low_decode <span style="color:#f92672">=</span> fn<span style="color:#f92672">.</span>decoders<span style="color:#f92672">.</span>image(self<span style="color:#f92672">.</span>lows, device<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;mixed&#34;</span>)
</span></span><span style="display:flex;"><span>        high_decode <span style="color:#f92672">=</span> fn<span style="color:#f92672">.</span>decoders<span style="color:#f92672">.</span>image(self<span style="color:#f92672">.</span>highs, device<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;mixed&#34;</span>)
</span></span><span style="display:flex;"><span>        low_resize <span style="color:#f92672">=</span> fn<span style="color:#f92672">.</span>resize(low_decode, device<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;gpu&#34;</span>, resize_x<span style="color:#f92672">=</span>self<span style="color:#f92672">.</span>img_size, resize_y<span style="color:#f92672">=</span>self<span style="color:#f92672">.</span>img_size, interp_type<span style="color:#f92672">=</span>types<span style="color:#f92672">.</span>INTERP_TRIANGULAR)
</span></span><span style="display:flex;"><span>        high_resize <span style="color:#f92672">=</span> fn<span style="color:#f92672">.</span>resize(high_decode, device<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;gpu&#34;</span>, resize_x<span style="color:#f92672">=</span>self<span style="color:#f92672">.</span>img_size, resize_y<span style="color:#f92672">=</span>self<span style="color:#f92672">.</span>img_size, interp_type<span style="color:#f92672">=</span>types<span style="color:#f92672">.</span>INTERP_TRIANGULAR)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>low <span style="color:#f92672">=</span> fn<span style="color:#f92672">.</span>transpose(low_resize, perm<span style="color:#f92672">=</span>[<span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>]) <span style="color:#f92672">/</span> <span style="color:#ae81ff">255.0</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>high <span style="color:#f92672">=</span> fn<span style="color:#f92672">.</span>transpose(high_resize, perm<span style="color:#f92672">=</span>[<span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>]) <span style="color:#f92672">/</span> <span style="color:#ae81ff">255.0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> (self<span style="color:#f92672">.</span>low, self<span style="color:#f92672">.</span>high)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">iter_setup</span>(self):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>set_outputs(self<span style="color:#f92672">.</span>low, self<span style="color:#f92672">.</span>high)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CustomDALIGenericIterator</span>(DALIGenericIterator):
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __init__(self, pipelines, <span style="color:#f92672">**</span>kwargs):
</span></span><span style="display:flex;"><span>        output_maps <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;lows&#39;</span>, <span style="color:#e6db74">&#39;highs&#39;</span>]
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> isinstance(pipelines, list):
</span></span><span style="display:flex;"><span>            pipelines <span style="color:#f92672">=</span> [pipelines]
</span></span><span style="display:flex;"><span>        super(CustomDALIGenericIterator, self)<span style="color:#f92672">.</span>__init__(pipelines, output_maps, <span style="color:#f92672">**</span>kwargs)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>pipelines <span style="color:#f92672">=</span> pipelines  <span style="color:#75715e"># devices &gt; 1 ==&gt; pipelines &gt; 1</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __next__(self):
</span></span><span style="display:flex;"><span>        batch <span style="color:#f92672">=</span> super(CustomDALIGenericIterator, self)<span style="color:#f92672">.</span>__next__()
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>parse_batch(batch)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __len__(self):
</span></span><span style="display:flex;"><span>        lengths <span style="color:#f92672">=</span> [len(i) <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>pipelines]
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> sum(lengths)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">parse_batch</span>(self, batch):
</span></span><span style="display:flex;"><span>        lows, highs <span style="color:#f92672">=</span> batch[<span style="color:#ae81ff">0</span>][<span style="color:#e6db74">&#39;lows&#39;</span>], batch[<span style="color:#ae81ff">0</span>][<span style="color:#e6db74">&#39;highs&#39;</span>] 
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> lows, highs
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>DATA_DIR <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/home/jensen/workspace/SYNTHESIS_DATA&#34;</span>
</span></span><span style="display:flex;"><span>BATCH_SIZE <span style="color:#f92672">=</span> <span style="color:#ae81ff">128</span>
</span></span><span style="display:flex;"><span>IMAGE_SIZE <span style="color:#f92672">=</span> <span style="color:#ae81ff">192</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>files <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>listdir(os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(DATA_DIR, <span style="color:#e6db74">&#39;low&#39;</span>))
</span></span><span style="display:flex;"><span>train_files, val_files <span style="color:#f92672">=</span> random_split(files, (<span style="color:#ae81ff">152000</span>, <span style="color:#ae81ff">1856</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>val_iter <span style="color:#f92672">=</span> ExternalInputIterator(batch_size<span style="color:#f92672">=</span>BATCH_SIZE, files<span style="color:#f92672">=</span>val_files, data_dir<span style="color:#f92672">=</span>DATA_DIR)
</span></span><span style="display:flex;"><span>val_pipe <span style="color:#f92672">=</span> ExternalSourcePipeline(val_iter, batch_size<span style="color:#f92672">=</span>BATCH_SIZE, num_threads<span style="color:#f92672">=</span><span style="color:#ae81ff">4</span>, device_id<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, img_size<span style="color:#f92672">=</span>IMAGE_SIZE)
</span></span><span style="display:flex;"><span>val_loader <span style="color:#f92672">=</span> CustomDALIGenericIterator(val_pipe)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">%%</span>time
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> idx, data <span style="color:#f92672">in</span> enumerate(val_loader):
</span></span><span style="display:flex;"><span>    X, Y <span style="color:#f92672">=</span> data
</span></span><span style="display:flex;"><span>    print(X<span style="color:#f92672">.</span>shape)
</span></span></code></pre></div><p>ä¸Šé¢çš„ä¾‹å­ä½¿ç”¨NVIDIA DALIè‡ªå®šä¹‰äº†æ•°æ®çš„è¿­ä»£æ–¹å¼ä»¥åŠåŠ è½½æ–¹å¼ï¼ŒåŒæ ·ä½¿ç”¨<code>jupyter</code>çš„<code>%%time</code>é­”æ³•å‡½æ•°æ¥è®¡ç®—éå†ä¸€éæ‰€èŠ±è´¹çš„æ—¶é—´ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæ•´ä¸ªè¿‡ç¨‹ä»…èŠ±è´¹äº†ä¸åˆ°3ç§’é’Ÿã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/Jen-Jon/CDN_Bank/img_src/20220608/005.png" alt="005"></p>
<p>æ­¤å¤–ï¼Œå¯ä»¥æ¨¡æ‹Ÿå°†æ•°æ®è¾“å…¥AlexNetä¸­å¤„ç†ï¼ŒGPUçš„åˆ©ç”¨ç‡ä¹Ÿä¼šä¸€ç›´ç¨³å®šåœ¨85%ä»¥ä¸Šï¼Œè¡¨æ˜GPUçš„æ€§èƒ½è¢«å……åˆ†åˆ©ç”¨ã€‚</p>
<h2 id="å¤šå¡ç¯å¢ƒä¸‹çš„nvidia-daliä½¿ç”¨">å¤šå¡ç¯å¢ƒä¸‹çš„NVIDIA DALIä½¿ç”¨</h2>
<p>æœ¬æ–‡ä¸­æ‰€æŒ‡çš„å¤šå¡ç¯å¢ƒæ˜¯å•æœºå¤šå¡ç¯å¢ƒï¼Œå³åœ¨ä¸€å°æœºå™¨çš„å¤šä¸ªGPUä¸Šè¿›è¡Œåˆ†å¸ƒå¼è®­ç»ƒï¼Œç„¶è€Œå¤šæœºå¤šå¡çš„æƒ…å†µå¹¶ä¸åœ¨æœ¬æ–‡çš„è®¨è®ºèŒƒç•´ä¹‹å†…ï¼Œæˆ‘ä¹Ÿç¡®å®æ²¡æœ‰ç”¨è¿‡è¿™ç§è®­ç»ƒæ–¹å¼ã€‚æœ‰å…³å¤šå¡ç¯å¢ƒä¸‹çš„ä½¿ç”¨æ–¹å¼ä¹Ÿå¯ä»¥å‚è€ƒ<a href="https://docs.nvidia.com/deeplearning/dali/user-guide/docs/examples/general/multigpu.html">å®˜æ–¹æ–‡æ¡£</a>ã€‚ä¸‹é¢ç›´æ¥æ”¾å‡ºæˆ‘çš„ä¾‹å­å§ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> os
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> nvidia.dali.fn <span style="color:#66d9ef">as</span> fn
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> nvidia.dali.types <span style="color:#66d9ef">as</span> types
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> torch.utils.data <span style="color:#f92672">import</span> random_split
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> nvidia.dali.pipeline <span style="color:#f92672">import</span> Pipeline
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> nvidia.dali.plugin.pytorch <span style="color:#f92672">import</span> DALIGenericIterator, LastBatchPolicy
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SyntheicDataPipeline</span>(Pipeline):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    An extended Pipeline class based on the Nvidia DALI library for low-light image enhancement.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    The effect of the Pipeline class is somewhat similar to the Dataset class in Pytorch and 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    the transforms function in torchvision. Mainly is to carry on some simple preprocessing to the input data.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Args:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        batch_size (int): batch_size.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        data_dir (str): the folder path of the paired image. (excluding the &#39;low&#39; and&#39; high&#39; folders)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        files (list): A list of paired image filenames.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        image_size (int | tuple): image size after resize operation.  Default: 192
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        num_threads (int): number of CPU threads used by the pipeline.  Default: 2
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        device_id (int): id of GPU used by the pipeline.  Default: 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        seed (int): seed used for random number generation.  Default: -1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        shard_id (int): index of the shard to read.  Default: 0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        num_shards (int): partitions the data into the specified number of parts (shards).  Default: 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        random_shuffle (bool): determines whether to randomly shuffle data.  Default: True
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Examples:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        When you have a GPU, device_id and shard_id should be set to 0 and num_shards should be set to 1.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        When you have four GPU, the value range for device_id and shard_id is [0-3] (device_id and shard_id 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        values are usually the same), and num_shards should be set to 4.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    For details, please refer to the official DALI documentation: https://docs.nvidia.com/deeplearning/dali/user-guide/docs/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    or my blog (which will be updated in the near future): https://jensen.dlab.ac.cn/ .
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __init__(self, batch_size, data_dir, files, 
</span></span><span style="display:flex;"><span>                 image_size<span style="color:#f92672">=</span><span style="color:#ae81ff">192</span>, num_threads<span style="color:#f92672">=-</span><span style="color:#ae81ff">1</span>, device_id<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, seed<span style="color:#f92672">=-</span><span style="color:#ae81ff">1</span>, 
</span></span><span style="display:flex;"><span>                 shard_id<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, num_shards<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, random_shuffle<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, <span style="color:#f92672">**</span>kwargs):
</span></span><span style="display:flex;"><span>        super(SyntheicDataPipeline, self)<span style="color:#f92672">.</span>__init__(batch_size<span style="color:#f92672">=</span>batch_size, num_threads<span style="color:#f92672">=</span>num_threads, 
</span></span><span style="display:flex;"><span>                                                   device_id<span style="color:#f92672">=</span>device_id, seed<span style="color:#f92672">=</span>seed, <span style="color:#f92672">**</span>kwargs)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>types <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;low&#39;</span>, <span style="color:#e6db74">&#39;high&#39;</span>]
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>data_dir <span style="color:#f92672">=</span> [os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(data_dir, name) <span style="color:#66d9ef">for</span> name <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>types]
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>files <span style="color:#f92672">=</span> list(files)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>image_size <span style="color:#f92672">=</span> image_size
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>shard_id <span style="color:#f92672">=</span> shard_id
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>num_shards <span style="color:#f92672">=</span> num_shards
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>random_shuffle <span style="color:#f92672">=</span> random_shuffle
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">define_graph</span>(self):
</span></span><span style="display:flex;"><span>        low_inputs, _ <span style="color:#f92672">=</span> fn<span style="color:#f92672">.</span>readers<span style="color:#f92672">.</span>file(file_root<span style="color:#f92672">=</span>self<span style="color:#f92672">.</span>data_dir[<span style="color:#ae81ff">0</span>], files<span style="color:#f92672">=</span>self<span style="color:#f92672">.</span>files, seed<span style="color:#f92672">=</span><span style="color:#ae81ff">1234</span>, 
</span></span><span style="display:flex;"><span>                                        shard_id<span style="color:#f92672">=</span>self<span style="color:#f92672">.</span>shard_id, num_shards<span style="color:#f92672">=</span>self<span style="color:#f92672">.</span>num_shards, 
</span></span><span style="display:flex;"><span>                                        random_shuffle<span style="color:#f92672">=</span>self<span style="color:#f92672">.</span>random_shuffle, pad_last_batch<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, 
</span></span><span style="display:flex;"><span>                                        name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;main_reader&#34;</span>)
</span></span><span style="display:flex;"><span>        high_inputs, _ <span style="color:#f92672">=</span> fn<span style="color:#f92672">.</span>readers<span style="color:#f92672">.</span>file(file_root<span style="color:#f92672">=</span>self<span style="color:#f92672">.</span>data_dir[<span style="color:#ae81ff">1</span>], files<span style="color:#f92672">=</span>self<span style="color:#f92672">.</span>files, seed<span style="color:#f92672">=</span><span style="color:#ae81ff">1234</span>,
</span></span><span style="display:flex;"><span>                                         shard_id<span style="color:#f92672">=</span>self<span style="color:#f92672">.</span>shard_id, num_shards<span style="color:#f92672">=</span>self<span style="color:#f92672">.</span>num_shards, 
</span></span><span style="display:flex;"><span>                                         random_shuffle<span style="color:#f92672">=</span>self<span style="color:#f92672">.</span>random_shuffle, pad_last_batch<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>        inputs <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#39;low&#39;</span>: low_inputs, <span style="color:#e6db74">&#39;high&#39;</span>: high_inputs}
</span></span><span style="display:flex;"><span>        images <span style="color:#f92672">=</span> {x: fn<span style="color:#f92672">.</span>decoders<span style="color:#f92672">.</span>image(inputs[x], device<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;mixed&#34;</span>) <span style="color:#66d9ef">for</span> x <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>types}
</span></span><span style="display:flex;"><span>        resizes <span style="color:#f92672">=</span> {x: fn<span style="color:#f92672">.</span>resize(images[x], device<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;gpu&#34;</span>, resize_x<span style="color:#f92672">=</span>self<span style="color:#f92672">.</span>image_size, 
</span></span><span style="display:flex;"><span>                                resize_y<span style="color:#f92672">=</span>self<span style="color:#f92672">.</span>image_size, interp_type<span style="color:#f92672">=</span>types<span style="color:#f92672">.</span>INTERP_TRIANGULAR) 
</span></span><span style="display:flex;"><span>                                <span style="color:#66d9ef">for</span> x <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>types}
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>tensors <span style="color:#f92672">=</span> {x: fn<span style="color:#f92672">.</span>transpose(resizes[x], perm<span style="color:#f92672">=</span>[<span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>]) <span style="color:#f92672">/</span> <span style="color:#ae81ff">255.0</span> <span style="color:#66d9ef">for</span> x <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>types}
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> (self<span style="color:#f92672">.</span>tensors[<span style="color:#e6db74">&#39;low&#39;</span>], self<span style="color:#f92672">.</span>tensors[<span style="color:#e6db74">&#39;high&#39;</span>])
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">iter_setup</span>(self):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>set_outputs(self<span style="color:#f92672">.</span>tensors[<span style="color:#e6db74">&#39;low&#39;</span>], self<span style="color:#f92672">.</span>tensors[<span style="color:#e6db74">&#39;high&#39;</span>])
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SyntheicDataIterator</span>(DALIGenericIterator):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    An extended Iterator class based on the Nvidia DALI library for low-light image enhancement.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    The effect of the Iterator class is somewhat similar to the Dataloader class in Pytorch.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Args:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        pipelines (nvidia.dali.Pipeline): pipelines.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        reader_name (str): name of the reader which will be queried to the shard size, 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                           number of shards and all other properties necessary to count 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                           properly the number of relevant and padded samples that iterator 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                           needs to deal with.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        last_batch_policy (int): strategy for processing the last batch data. (especially if the
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                              size of the last batch data is smaller than batch_size)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        output_map (list): list of strings which maps consecutive outputs of DALI pipelines to user specified name.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Example:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        loader = SyntheicDataIterator(...)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        for idx, data in enumerate(loader):
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            low, high = data
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            ...
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    For details, please refer to the official DALI documentation: https://docs.nvidia.com/deeplearning/dali/user-guide/docs/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    or my blog (which will be updated in the near future): https://jensen.dlab.ac.cn/ .
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __init__(self, pipelines, reader_name, last_batch_policy, 
</span></span><span style="display:flex;"><span>                 output_map<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;low&#39;</span>, <span style="color:#e6db74">&#39;high&#39;</span>], <span style="color:#f92672">**</span>kwargs):
</span></span><span style="display:flex;"><span>        super(SyntheicDataIterator, self)<span style="color:#f92672">.</span>__init__(pipelines<span style="color:#f92672">=</span>pipelines, output_map<span style="color:#f92672">=</span>output_map, 
</span></span><span style="display:flex;"><span>                                                   reader_name<span style="color:#f92672">=</span>reader_name, last_batch_policy<span style="color:#f92672">=</span>last_batch_policy, 
</span></span><span style="display:flex;"><span>                                                   <span style="color:#f92672">**</span>kwargs)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_parse_data</span>(self, data):
</span></span><span style="display:flex;"><span>        low_data, high_data <span style="color:#f92672">=</span> data[<span style="color:#ae81ff">0</span>][<span style="color:#e6db74">&#39;low&#39;</span>], data[<span style="color:#ae81ff">0</span>][<span style="color:#e6db74">&#39;high&#39;</span>]
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> low_data, high_data
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __next__(self):
</span></span><span style="display:flex;"><span>        data <span style="color:#f92672">=</span> super(SyntheicDataIterator, self)<span style="color:#f92672">.</span>__next__()
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>_parse_data(data)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __len__(self):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> super(SyntheicDataIterator, self)<span style="color:#f92672">.</span>__len__()
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>DATA_DIR <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/home/jensen/workspace/SYNTHESIS_DATA&#34;</span>
</span></span><span style="display:flex;"><span>BATCH_SIZE <span style="color:#f92672">=</span> <span style="color:#ae81ff">128</span>
</span></span><span style="display:flex;"><span>IMAGE_SIZE <span style="color:#f92672">=</span> <span style="color:#ae81ff">192</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>files <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>listdir(os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(DATA_DIR, <span style="color:#e6db74">&#39;low&#39;</span>))
</span></span><span style="display:flex;"><span>train_files, val_files <span style="color:#f92672">=</span> random_split(files, (<span style="color:#ae81ff">152000</span>, <span style="color:#ae81ff">1856</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pipe <span style="color:#f92672">=</span> SyntheicDataPipeline(batch_size<span style="color:#f92672">=</span>BATCH_SIZE, num_threads<span style="color:#f92672">=</span><span style="color:#ae81ff">4</span>, device_id<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, 
</span></span><span style="display:flex;"><span>                            seed<span style="color:#f92672">=</span><span style="color:#ae81ff">1234</span>, data_dir<span style="color:#f92672">=</span>DATA_DIR, files<span style="color:#f92672">=</span>val_files, 
</span></span><span style="display:flex;"><span>                            image_size<span style="color:#f92672">=</span>IMAGE_SIZE, shard_id<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, num_shards<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>val_loader <span style="color:#f92672">=</span> SyntheicDataIterator(pipe, reader_name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;main_reader&#34;</span>, auto_reset<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, 
</span></span><span style="display:flex;"><span>                                  last_batch_policy<span style="color:#f92672">=</span>LastBatchPolicy<span style="color:#f92672">.</span>PARTIAL)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> idx, data <span style="color:#f92672">in</span> enumerate(val_loader):
</span></span><span style="display:flex;"><span>    X, Y <span style="color:#f92672">=</span> data
</span></span><span style="display:flex;"><span>    print(X<span style="color:#f92672">.</span>shape)
</span></span></code></pre></div><p>ä¸Šé¢çš„ä¾‹å­å…¶å®è¿˜æ˜¯å•æœºå•å¡çš„ç¯å¢ƒï¼Œä½†æ˜¯åªè¦ç¨å¾®ä¿®æ”¹ä¸€ä¸‹å°±å¯ä»¥å®ç°å•æœºå¤šå¡ã€‚å³å°†<code>SyntheicDataPipeline</code>ç±»ä¸­çš„<code>device_id</code>å’Œ<code>shard_id</code>ä»¥åŠ<code>num_shards</code>è¿™ä¸‰ä¸ªå‚æ•°ç¨ä½œä¿®æ”¹ã€‚<code>device_id</code>å¾ˆå¥½ç†è§£äº†ï¼Œä¾‹å¦‚ä¸€å°æœºå™¨æœ‰å››å¼ GPUï¼Œåˆ™<code>device_id</code>åˆ†åˆ«ä¸º<code>0</code>ã€<code>1</code>ã€<code>2</code>ã€<code>3</code>ã€‚å‡å¦‚åœ¨ç¬¬äºŒå¼ GPUä¸Šè¿›è¡Œè¿ç®—ï¼Œåˆ™<code>device_id</code>å°±æ˜¯<code>2</code>ï¼Œæ­¤å¤–<code>shard_id</code>ä¸€èˆ¬ä¸<code>device_id</code>ä¿æŒä¸€è‡´ï¼Œå®ƒæ˜¯æŒ‡ç¬¬å‡ ä¸ªåˆ†ç‰‡ï¼ˆåˆ†å¸ƒå¼è®­ç»ƒçš„å®è´¨å°±æ˜¯å°†ä¸€ä¸ªå¤§batchçš„æ•°æ®å‡åˆ†åˆ°æ¯ä¸ªGPUä¸Šæ¥å¹¶è¡Œè¿ç®—ï¼Œå› æ­¤ç¬¬ä¸€å¼ GPUä¸Šè¾“å…¥çš„æ•°æ®åº”å½“å°±æ˜¯å‡åˆ†æ•°æ®å¾—åˆ°çš„ç¬¬ä¸€ä¸ªåˆ†ç‰‡ï¼‰ã€‚<code>num_shards</code>è¿™ä¸ªå‚æ•°ä¹Ÿå¾ˆå¥½ç†è§£ï¼Œå®ƒçš„æ„æ€å³ä¸€å…±æœ‰å¤šå°‘å¼ GPUã€‚è™½ç„¶çœ‹èµ·æ¥å¾ˆç®€å•ï¼Œä½†æ˜¯è¿˜æ˜¯æœ‰ä¸‰ä¸ªå‚æ•°éœ€è¦ä¿®æ”¹ï¼Œä¼¼ä¹è¿˜æ˜¯æœ‰ç‚¹éº»çƒ¦ï¼Œä½†æ˜¯ä¸ç”¨æ‹…å¿ƒï¼Œå®é™…ä¸Šè¿™äº›å‚æ•°éƒ½æ˜¯ä¸éœ€è¦äººä¸ºå»è®¾å®šã€‚å› ä¸ºé€šå¸¸åˆ†å¸ƒå¼è®­ç»ƒéƒ½éœ€è¦ä»å‘½ä»¤è¡Œä¼ å…¥ä¸€ä¸ªå‚æ•°<code>--nproc_per_node</code>ï¼Œé€šè¿‡è¿™ä¸€ä¸ªå‚æ•°éƒ½èƒ½è‡ªé€‚åº”çš„å®Œæˆä¸Šè¿°å‚æ•°çš„ä¿®æ”¹ï¼Œåœ¨å®é™…è®­ç»ƒçš„æ—¶å€™ï¼Œåªéœ€åšå¦‚ä¸‹ä¿®æ”¹å³å¯ï¼š<code>device_id=args.local_rank</code>ã€<code>shard_id=args.local_rank</code>ã€<code>num_shards=args.world_size</code>ã€‚</p>
<p>å¥½äº†ï¼Œæœ¬ç¯‡åšå®¢åˆ°è¿™é‡Œå°±åº”è¯¥è¦ç»“æŸäº†ï¼Œæœ¬æ–‡ä¸­æåˆ°çš„æ–¹æ³•é€šå¸¸éƒ½èƒ½é€‚ç”¨äºå„ç§æ·±åº¦å­¦ä¹ ä»»åŠ¡ï¼Œåªæ˜¯ä¸åŒçš„ä»»åŠ¡åœ¨æ•°æ®è¯»å–ä¸Šå¯èƒ½ä¼šæœ‰ä¸€äº›å¼‚åŒï¼Œä½†æˆ‘ç›¸ä¿¡è¿™äº›é—®é¢˜éƒ½å¯ä»¥é€šè¿‡å‚é˜…å®˜æ–¹æ–‡æ¡£ä¸­çš„<code>nvidia.dali.fn</code>ä½¿ç”¨è¯´æ˜æ¥è§£å†³ã€‚æ¥ä¸‹æ¥å¦‚æœæœ‰æ—¶é—´çš„è¯æˆ‘ä¼šå†ä»‹ç»ä¸€ä¸‹å¦‚ä½•ä½¿ç”¨NVIDIA APEXåº“æ¥å®ç°åˆ†å¸ƒå¼è®­ç»ƒä»¥åŠå¦‚ä½•å°†NVIDIA DALIå’ŒAPEXåº“ç»“åˆèµ·æ¥ä½¿ç”¨ã€‚</p>

    <div class="CornerButtons">
        <div class="CornerAnimayedFlex">
            <div class="CornerButton" title="Back to the top">
                <a href="#top" class="cba fas fa-hand-middle-finger" ></a>
            </div>
        </div>
    </div>

<hr>

<h1 style="color: #1f71e0;">Comments</h1>
<script defer src="https://utteranc.es/client.js" 
repo="Jen-Jon/Jen-Jon.github.io" 
issue-term="title" 
theme="github-light" 
crossorigin="anonymous" async></script>


</div>

<h5 style="text-align: center; font-size: large;">This blog is licensed under <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/">CC BY-NC-ND 4.0</a>, please indicate the source for non-commercial reposted.</h5>


        </div><strong id="footer" class="mb-5">
    <hr>
    
    <div class="container text-center">
        
            <a href="https://github.com/Jen-Jon/" class="fab fa-github fa-1x" title="Github" style="text-decoration: none;"></a>
        
            <a href="https://hub.docker.com/u/ijerry22" class="fab fa-docker fa-1x" title="DockerHub" style="text-decoration: none;"></a>
        
            <a href="https://www.researchgate.net/profile/Jingyao-Zhang-4" class="fab fa-researchgate fa-1x" title="researchgate" style="text-decoration: none;"></a>
        
            <a href="mailto:jensen.acm@gmail.com" class="fas fa-envelope fa-1x" title="E-mail" style="text-decoration: none;"></a>
        
    </div>
    
        <div class="container text-center">
            <h5 class="text-center" style="font-size: small;">Copyright Â© 2020-2022 <a href="https://github.com/Jen-Jon/" style="color: #1f71e0;" title="Jensen-Jon">Jensen-Jon</a>. All rights reserved.</h5>
        </div>
    
</div>
</body>
</html>
